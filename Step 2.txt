Tuyệt vời! Bây giờ chúng ta sẽ bắt tay vào viết **Phần Cốt Lõi (Core Logic)**. Đây là lúc biến con VPS 1 CPU của bạn thành một "cỗ máy xay tin tức" không biết mệt mỏi.

Chúng ta sẽ chia làm 2 phần code chính:

1. **Ingestor (Người nghe):** Tai mắt của hệ thống.
2. **Worker (Người làm):** Bộ não phân tích.

Hãy mở VS Code (đã kết nối SSH với VPS) và sử dụng các Prompt sau cho Copilot.

---

### Phần 1: Xây dựng Ingestor (Producer)

Module này chỉ có một nhiệm vụ duy nhất: **Nghe tin nhắn -> Đóng gói -> Quăng vào Redis.** Nó phải chạy siêu nhanh để không bỏ lỡ tin nào.

**File mục tiêu:** `src/ingestor/main.py`

**Prompt cho Copilot:**

> "Dựa trên `PROJECT_CONTEXT.md` (Native Linux Edition). Hãy đóng vai Python Backend Developer.
> Viết code cho file `src/ingestor/main.py` thực hiện các nhiệm vụ sau:
> 1. **Setup Telethon Client:**
> * Load `API_ID`, `API_HASH`, `SESSION_STRING` từ biến môi trường (`.env`).
> * Khởi tạo `TelegramClient` chế độ Userbot.
> 
> 
> 2. **Setup Redis Connection:**
> * Sử dụng thư viện `redis.asyncio` để tạo connection pool tới `localhost:6379`.
> 
> 
> 3. **Event Handler (NewMessage):**
> * Lắng nghe sự kiện `events.NewMessage(incoming=True)`.
> * **Logic quan trọng:**
> * Bỏ qua tin nhắn từ chính mình (`event.out`).
> * Trích xuất dữ liệu: `chat_id`, `message_text`, `date`, `sender_id`, `message_id`.
> * Tạo dictionary `payload`.
> * Dùng `json.dumps` để serialize payload.
> * Đẩy vào Redis List bằng lệnh `rpush` với key là `queue:raw_messages`.
> 
> 
> 
> 
> 4. **Logging:** Dùng `loguru` để in log: 'Captured message from {chat_id}'.
> 5. **Main Loop:** Chạy `client.run_until_disconnected()`."
> 
> 

---

### Phần 2: Xây dựng Worker (Consumer)

Đây là nơi phép màu xảy ra. Module này sẽ lấy tin từ Redis và quyết định xem nó là "Vàng" hay "Rác".

**File mục tiêu:** `src/worker/main.py`

**Prompt cho Copilot:**

> "Bây giờ hãy viết code cho `src/worker/main.py`. Đây là module xử lý logic nặng.
> 1. **Cấu trúc vòng lặp vô tận (Infinite Loop):**
> * Kết nối Redis (`asyncio`) và Database (SQLAlchemy).
> * Dùng vòng lặp `while True`.
> * Dùng lệnh `blpop` (Blocking Pop) của Redis để chờ tin nhắn từ key `queue:raw_messages` (Timeout = 1s để tránh treo CPU).
> 
> 
> 2. **Xử lý tin nhắn (Process Logic):**
> * Khi nhận được JSON -> Parse ra dictionary.
> * **Bước 1: Deduplication (Chống trùng):**
> * Tạo một `hash_string` từ nội dung tin nhắn.
> * Kiểm tra xem key `dedup:{hash_string}` có tồn tại trong Redis không.
> * Nếu có -> `continue` (Bỏ qua).
> * Nếu không -> Set key `dedup:{hash_string}` vào Redis với thời gian hết hạn (TTL) là 300 giây (5 phút).
> 
> 
> 
> 
> 3. **Bước 2: Lọc tin (Filter Engine):**
> * *(Giả định bạn đã có hàm `get_users_watching_chat(chat_id)` từ DB)*.
> * Lấy danh sách User đang theo dõi `chat_id` này.
> * Với mỗi User, lấy danh sách `Keywords` của họ.
> * Dùng Regex kiểm tra: Nếu `message_text` chứa Keyword -> Đẩy một Job mới vào Redis queue khác tên là `queue:notifications` (để module Bot gửi tin sau).
> 
> 
> 4. **Lưu ý hiệu năng:** Code phải dùng `async/await` triệt để vì tôi chỉ có 1 CPU."
> 
> 

---

### Giải thích cơ chế "Chống trùng" (Deduplication)

Bạn có để ý đoạn **Deduplication** trong Prompt Worker không? Đây là tính năng "ăn tiền".

* **Vấn đề:** Trong Crypto, một tin "Hot" sẽ được 10 nhóm copy-paste lại.
* **Nếu không có Deduplication:** User nhận 10 tin báo giống hệt nhau -> Spam -> User hủy đăng ký.
* **Có Deduplication:** User chỉ nhận tin đầu tiên. 9 tin sau (trong vòng 5 phút) sẽ bị Bot âm thầm loại bỏ.

---

### Bước tiếp theo: Chạy thử!

Sau khi Copilot viết xong 2 file trên. Bạn cần làm 2 việc để test xem hệ thống có chạy không:

1. **Tạo file `.env`:**
Điền thông tin của bạn vào (lấy từ my.telegram.org):
```env
API_ID=123456
API_HASH=abcdef...
REDIS_URL=redis://localhost:6379/0
DATABASE_URL=postgresql+asyncpg://user:pass@localhost/alpha_hunter

```


2. **Chạy thử bằng tay (2 terminal):**
* Terminal 1: `python src/ingestor/main.py` (Để bắt đầu nghe).
* Terminal 2: `python src/worker/main.py` (Để bắt đầu xử lý).



**Bạn hãy prompt cho Copilot viết code đi nhé. Nếu code sinh ra có chỗ nào báo lỗi hoặc bạn chưa hiểu, cứ copy lỗi đó quăng vào đây tôi sửa cho!**