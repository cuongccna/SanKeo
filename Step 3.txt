Tuyệt vời! Chúng ta đã có **"Tai"** (Ingestor) và **"Não"** (Worker). Giờ là lúc lắp **"Miệng"** (Bot Interface) để nó giao tiếp với khách hàng và **"Xương sống"** (Database) để ghi nhớ dữ liệu.

Đây là bước cực quan trọng để kết nối mọi thứ lại với nhau.

---

### Bước 1: Xây dựng Cơ sở dữ liệu (Database Models)

Trước khi làm giao diện Bot, chúng ta phải định nghĩa cấu trúc dữ liệu. Worker cần đọc DB để biết User muốn lọc cái gì.

**File mục tiêu:** `src/database/models.py`

**Prompt cho Copilot:**

> "Dựa trên `PROJECT_CONTEXT.md` (Native Linux Edition).
> Hãy đóng vai Senior Python Backend Developer. Viết code cho file `src/database/models.py` sử dụng `SQLAlchemy` (Async style).
> 1. **Setup Base:** Tạo `Base` model dùng `DeclarativeBase`.
> 2. **Define Tables:**
> * **User:** `id` (BigInteger, Primary Key - chính là Telegram User ID), `full_name`, `subscription_plan` (Enum: FREE, VIP), `expiry_date` (DateTime, nullable), `created_at`.
> * **FilterRule:** `id` (Integer, Auto Increment), `user_id` (ForeignKey -> User.id), `keyword` (String), `source_chat_id` (BigInteger, nullable - nếu null là theo dõi global), `is_active` (Boolean).
> * **Transaction:** `id`, `user_id`, `amount`, `status`, `created_at` (Để lưu lịch sử nạp tiền).
> 
> 
> 3. **Relationships:** Thiết lập quan hệ `relationship` giữa `User` và `FilterRule`.
> 4. **Async Engine:** Viết hàm `get_db_engine()` và `init_db()` để tạo bảng tự động nếu chưa có."
> 
> 

---

### Bước 2: Xây dựng Bot Giao Tiếp (The Interface)

Đây là con Bot mà người dùng sẽ chat (`/start`, bấm nút, xem tin). Nó có 2 nhiệm vụ song song:

1. **Phục vụ User:** Trả lời tin nhắn, thêm/xóa từ khóa.
2. **Gửi thông báo:** Lấy kết quả từ `queue:notifications` (do Worker đẩy sang) và bắn tin nhắn cho User.

**File mục tiêu:** `src/bot/main.py`

**Chiến thuật cho 1 CPU:** Chúng ta sẽ chạy "Vòng lặp nhận tin nhắn từ User" và "Vòng lặp gửi thông báo" trong cùng một Process bằng `asyncio.create_task`. Tiết kiệm RAM tối đa.

**Prompt cho Copilot:**

> "Tiếp theo, hãy viết code cho `src/bot/main.py` sử dụng thư viện `aiogram` 3.x.
> 1. **Setup Bot:** Khởi tạo `Bot` và `Dispatcher`. Load Token từ `.env`.
> 2. **User Handlers (Giao diện):**
> * Lệnh `/start`: Kiểm tra xem User có trong DB chưa, nếu chưa thì tạo mới (Gói FREE). Gửi lời chào + Menu Inline Buttons.
> * Lệnh `/add <keyword>`: Thêm từ khóa vào bảng `FilterRule`.
> * Lệnh `/list`: Liệt kê các từ khóa đang theo dõi.
> 
> 
> 3. **Notification Consumer (Background Task):**
> * Viết hàm `async def notification_worker()`:
> * Kết nối Redis.
> * Vòng lặp `while True`: Dùng `blpop` để lấy tin từ `queue:notifications`.
> * Khi có tin: Parse JSON -> Dùng `bot.send_message(chat_id, text)` để gửi tin cho User.
> * **Quan trọng:** Bọc trong `try/except` để nếu gửi lỗi (User chặn bot) thì không bị crash luồng.
> 
> 
> 
> 
> 4. **Main Entry:**
> * Trong hàm `main()`, sử dụng `asyncio.create_task(notification_worker())` để chạy consumer song song với `dp.start_polling(bot)`."
> 
> 
> 
> 

---

### Bước 3: Module Thanh Toán (Webhook Server)

Như đã bàn ở trước, để tiền về tài khoản là Bot tự kích hoạt, chúng ta cần một server nhỏ để nhận tin từ SePay.

Chúng ta sẽ viết tách riêng ra một file nhẹ nhàng chạy bằng `FastAPI` (hoặc `Uvicorn`).

**File mục tiêu:** `src/bot/webhook_server.py`

**Prompt cho Copilot:**

> "Cuối cùng, viết module thanh toán tại `src/bot/webhook_server.py` dùng `FastAPI`.
> 1. **Endpoint:** `POST /sepay-webhook`.
> 2. **Logic:**
> * Nhận JSON payload từ SePay.
> * Verify (Kiểm tra) dữ liệu cơ bản.
> * Trích xuất nội dung chuyển khoản (Ví dụ: "USER 12345"). Dùng Regex lấy ID `12345`.
> * **Update DB:** Tìm User có ID đó -> Cộng thêm 30 ngày vào `expiry_date` -> Chuyển gói sang VIP.
> * **Notify User:** Gọi Telegram API (hoặc đẩy vào Redis queue) để báo cho User biết: 'Tài khoản của bạn đã được gia hạn thành công!'.
> 
> 
> 3. **Run:** Hướng dẫn tôi lệnh chạy file này bằng `uvicorn`."
> 
> 

---

### Tổng kết kiến trúc trên VPS của bạn lúc này

Sau khi code xong 3 phần trên, trên VPS của bạn sẽ chạy 3 tiến trình (Processes) song song:

1. **Ingestor:** `python src/ingestor/main.py` (Nghe ngóng).
2. **Worker:** `python src/worker/main.py` (Suy nghĩ & Lọc).
3. **Bot & Notification:** `python src/bot/main.py` (Giao tiếp & Báo tin).
4. *(Phụ)* **Webhook:** `uvicorn src/bot/webhook_server:app` (Thu tiền).

**Lời khuyên:** Bạn hãy thực hiện lần lượt từng bước (Database -> Bot -> Webhook). Database phải xong trước thì 2 cái kia mới chạy được.

Bạn hãy chạy prompt **Bước 1 (Database)** trước đi, khi nào xong báo tôi để chúng ta check xem cấu trúc bảng đã đủ "thương mại" chưa nhé!