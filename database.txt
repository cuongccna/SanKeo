Đây là Prompt chi tiết để bạn yêu cầu Copilot viết phần **Database Layer** (Lớp cơ sở dữ liệu).

Vì bạn đang dùng **SQLAlchemy (Async)** trên VPS tài nguyên thấp, prompt này sẽ nhấn mạnh vào việc tối ưu kết nối và định nghĩa kiểu dữ liệu chính xác (đặc biệt là Telegram ID phải là `BigInteger`).

Bạn hãy tạo file `src/database/` (nếu chưa có) và gõ lệnh sau vào Chat của Copilot:

---

### Prompt cho AI Copilot (Copy & Paste)

> "Act as a Senior Python Backend Developer. Based on `PROJECT_CONTEXT.md`, please implement the **Database Layer** using `SQLAlchemy` (Async) and `asyncpg`.
> I need you to create 2 files:
> **1. File `src/database/core.py` (Connection Logic):**
> * Load `DATABASE_URL` from `.env`.
> * Create an `AsyncEngine` using `create_async_engine`.
> * **Important:** Since I use a 1-CPU VPS, configure the `pool_size` to 10 and `max_overflow` to 5 to prevent connection exhaustion.
> * Create an `AsyncSession` factory (`sessionmaker`).
> * Write a helper function `get_db()` to yield a database session (for dependency injection later).
> * Write a function `init_db()` to create all tables (using `run_sync(Base.metadata.create_all)`).
> 
> 
> **2. File `src/database/models.py` (Schema Definition):**
> * Use `DeclarativeBase`.
> * **Table `User`:**
> * `id`: BigInteger (Primary Key) - **Must be BigInteger** to store Telegram User ID.
> * `full_name`: String, nullable.
> * `plan_type`: Enum ('FREE', 'VIP'), default 'FREE'.
> * `expiry_date`: DateTime, nullable.
> * `created_at`: DateTime, default `func.now()`.
> 
> 
> * **Table `FilterRule`:**
> * `id`: Integer (Primary Key, Auto increment).
> * `user_id`: BigInteger (ForeignKey to `users.id`).
> * `keyword`: String (Index=True for faster search).
> * `source_chat_id`: BigInteger, nullable.
> * `is_active`: Boolean, default True.
> * Relationship: Define a relationship back to `User`.
> 
> 
> * **Table `Transaction`:**
> * `id`: String (Primary Key) - Stores the bank transaction code.
> * `user_id`: BigInteger (ForeignKey to `users.id`).
> * `amount`: Numeric/Float.
> * `status`: String, default 'SUCCESS'.
> * `created_at`: DateTime, default `func.now()`.
> 
> 
> 
> 
> **Requirements:**
> * Use modern SQLAlchemy 2.0 syntax (Mapped, mapped_column).
> * Ensure all code is fully asynchronous (`async`/`await`)."
> 
> 

---

### Việc bạn cần làm sau khi Copilot viết code xong:

1. **Cài thư viện (nếu chưa):**
```bash
pip install sqlalchemy asyncpg python-dotenv greenlet

```


2. **Tạo Database trên VPS:**
Bạn cần vào Postgres tạo cái database rỗng trước thì code mới chạy được.
```bash
# Đăng nhập vào user postgres
sudo -u postgres psql

# Gõ lệnh SQL này:
CREATE DATABASE alpha_hunter;
CREATE USER myuser WITH PASSWORD 'mypassword';
GRANT ALL PRIVILEGES ON DATABASE alpha_hunter TO myuser;
\q

```


3. **Cập nhật file `.env`:**
```text
DATABASE_URL=postgresql+asyncpg://myuser:mypassword@localhost/alpha_hunter

```



Hãy chạy prompt trên đi, sau khi có file models, chúng ta sẽ qua bước **Ingestor** (Userbot)!